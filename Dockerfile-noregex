# Multi-stage Dockerfile to build a minimal image without exrex dependency

# stage 1: build self-contained binary of this app
FROM golang:1.25-alpine AS app-builder
ENV CGO_ENABLED=0 GOOS=linux GOARCH=amd64

WORKDIR /src
COPY "cmd/" "./cmd/"
COPY internal/ ./internal/
COPY go.mod go.sum ./

RUN go mod download && \
    go build -ldflags="-s" -o /out/traefik-opnsense-sync "./cmd/traefik-opnsense-sync/main.go"


# stage 2: final minimal image (distroless instead of scratch for tls support)
FROM gcr.io/distroless/static-debian12:nonroot AS final

WORKDIR /app

COPY --from=app-builder /out/traefik-opnsense-sync ./

ENTRYPOINT ["/app/traefik-opnsense-sync"]
